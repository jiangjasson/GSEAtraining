<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Topic 2-04: Implement GSEA from scratch • GSEAtraining</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Topic 2-04: Implement GSEA from scratch">
<meta property="og:description" content="GSEAtraining">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">GSEAtraining</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.99.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/topic1_00_format.html">Topic 1-00: Representation of gene sets in R</a>
    </li>
    <li>
      <a href="../articles/topic1_01_GO.html">Topic 1-01: Get GO gene sets</a>
    </li>
    <li>
      <a href="../articles/topic1_02_kegg.html">Topic 1-02: Get pathways from KEGG</a>
    </li>
    <li>
      <a href="../articles/topic1_03_msigdbr.html">Topic 1-03: Get pathways from MSigDB</a>
    </li>
    <li>
      <a href="../articles/topic1_04_Reactome.html">Topic 1-04: Get pathways from Reactome</a>
    </li>
    <li>
      <a href="../articles/topic1_05_BioCarta.html">Topic 1-05: Get pathways from BioCarta</a>
    </li>
    <li>
      <a href="../articles/topic1_06_UniProtKeywords.html">Topic 1-06: Get gene sets from UniProt Keywords</a>
    </li>
    <li>
      <a href="../articles/topic1_07_more_gene_sets.html">Topic 1-07: Get GO/KEGG gene sets for other organisms</a>
    </li>
    <li>
      <a href="../articles/topic1_08_ortholog.html">Topic 1-08: Generate gene sets for other organisms by mapping to orthologues</a>
    </li>
    <li>
      <a href="../articles/topic1_09_gene_id.html">Topic 1-09: Gene ID conversion</a>
    </li>
    <li>
      <a href="../articles/topic2_01_ora_single_gene_set.html">Topic 2-01: ORA on a single gene set</a>
    </li>
    <li>
      <a href="../articles/topic2_02_implement_ora.html">Topic 2-02: Implement ORA from stratch</a>
    </li>
    <li>
      <a href="../articles/topic2_03_clusterProfiler_ora.html">Topic 2-03: Use clusterProfiler for ORA</a>
    </li>
    <li>
      <a href="../articles/topic2_04_implement_gsea.html">Topic 2-04: Implement GSEA from scratch</a>
    </li>
    <li>
      <a href="../articles/topic2_05_clusterProfiler_gsea.html">Topic 2-05: Use clusterProfiler for GSEA</a>
    </li>
    <li>
      <a href="../articles/topic2_06_compare_ORA_GSEA.html">Topic 2-06: Compare ORA and GSEA</a>
    </li>
    <li>
      <a href="../articles/topic3_01_online_GREAT.html">Topic 3-01: Online GREAT analysis</a>
    </li>
    <li>
      <a href="../articles/topic3_02_local_GREAT.html">Topic 3-02: Local GREAT analysis</a>
    </li>
    <li>
      <a href="../articles/topic3_03_goseq.html">Topic 3-03: GOseq</a>
    </li>
    <li>
      <a href="../articles/topic4_01_CePa.html">Topic 4-01: CePa</a>
    </li>
    <li>
      <a href="../articles/topic4_02_GSVA.html">Topic 4-02: GSVA</a>
    </li>
    <li>
      <a href="../articles/topic5_01_similarity.html">Topic 5-01: Similarities of terms</a>
    </li>
    <li>
      <a href="../articles/topic5_02_simplifyEnrichment.html">Topic 5-02: simplifyEnrichment</a>
    </li>
    <li>
      <a href="../articles/topic6_01_visualization.html">Topic 6-01: Visualization</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/jokergoo/GSEAtraining/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Topic 2-04: Implement GSEA from scratch</h1>
                        <h4 data-toc-skip class="author">Zuguang Gu <a href="mailto:z.gu@dkfz.de" class="email">z.gu@dkfz.de</a>
</h4>
            
            <h4 data-toc-skip class="date">2024-01-26</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/jokergoo/GSEAtraining/blob/HEAD/vignettes/topic2_04_implement_gsea.Rmd" class="external-link"><code>vignettes/topic2_04_implement_gsea.Rmd</code></a></small>
      <div class="hidden name"><code>topic2_04_implement_gsea.Rmd</code></div>

    </div>

    
    
<p>In this document, we will implement the two versions of GSEA in R, using the p53 dataset also from the GSEA paper.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lt</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"p53_expr.rds"</span>, package <span class="op">=</span> <span class="st">"GSEAtraining"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">expr</span> <span class="op">=</span> <span class="va">lt</span><span class="op">$</span><span class="va">expr</span></span>
<span><span class="va">condition</span> <span class="op">=</span> <span class="va">lt</span><span class="op">$</span><span class="va">condition</span></span>
<span></span>
<span><span class="va">ln</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/strsplit.html" class="external-link">strsplit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/readLines.html" class="external-link">readLines</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"c2.symbols.gmt"</span>, package <span class="op">=</span> <span class="st">"GSEAtraining"</span><span class="op">)</span><span class="op">)</span>, <span class="st">"\t"</span><span class="op">)</span></span>
<span><span class="va">gs</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">ln</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">[</span><span class="op">-</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">gs</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">ln</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">geneset</span> <span class="op">=</span> <span class="va">gs</span><span class="op">[[</span><span class="st">"p53hypoxiaPathway"</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<p>This gene set is very small:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">geneset</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 20</span></span></code></pre>
<p>Note here gene IDs in the expression matrix and in the gene set are all gene symbols, thus no more adjustment needs to be done here.</p>
<p>The gene-level difference score is set as signal-to-noise ratios, which is:</p>
<ul>
<li>mean in group 1</li>
<li>mean in group 2</li>
<li>sd in group 1</li>
<li>sd in group 2</li>
</ul>
<p><span class="math display">\[ \frac{\mu_1 - \mu_2}{\sigma_1 + \sigma_2} \]</span></p>
<p>We calculate the gene-level difference score in <code>s</code>:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">s</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">expr</span>, <span class="fl">1</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">x1</span> <span class="op">=</span> <span class="va">x</span><span class="op">[</span><span class="va">condition</span> <span class="op">==</span> <span class="st">"WT"</span><span class="op">]</span></span>
<span>    <span class="va">x2</span> <span class="op">=</span> <span class="va">x</span><span class="op">[</span><span class="va">condition</span> <span class="op">==</span> <span class="st">"MUT"</span><span class="op">]</span></span>
<span>    <span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">x1</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">x2</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="fu">sd</span><span class="op">(</span><span class="va">x1</span><span class="op">)</span> <span class="op">+</span> <span class="fu">sd</span><span class="op">(</span><span class="va">x2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>A faster way to calculate <code>s</code> is to use the <strong>matrixStats</strong> packages.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/HenrikBengtsson/matrixStats" class="external-link">matrixStats</a></span><span class="op">)</span></span>
<span><span class="va">m1</span> <span class="op">=</span> <span class="va">expr</span><span class="op">[</span>, <span class="va">condition</span> <span class="op">==</span> <span class="st">"WT"</span><span class="op">]</span>  <span class="co"># only samples in group 1</span></span>
<span><span class="va">m2</span> <span class="op">=</span> <span class="va">expr</span><span class="op">[</span>, <span class="va">condition</span> <span class="op">==</span> <span class="st">"MUT"</span><span class="op">]</span>  <span class="co"># only samples in group 2</span></span>
<span><span class="va">s</span> <span class="op">=</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">m1</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">m2</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/matrixStats/man/rowSds.html" class="external-link">rowSds</a></span><span class="op">(</span><span class="va">m1</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/matrixStats/man/rowSds.html" class="external-link">rowSds</a></span><span class="op">(</span><span class="va">m2</span><span class="op">)</span><span class="op">)</span> <span class="co"># gene-level difference scores</span></span></code></pre></div>
<p>Sort the gene scores from the highest to the lowest:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">s</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="va">s</span>, decreasing <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="gsea-version-1">GSEA version 1<a class="anchor" aria-label="anchor" href="#gsea-version-1"></a>
</h2>
<div class="section level3">
<h3 id="calculate-enrichment-score">Calculate enrichment score<a class="anchor" aria-label="anchor" href="#calculate-enrichment-score"></a>
</h3>
<p>Next we first implement the original GSEA method, which was proposed in Mootha et al., 2003.</p>
<p>We calculate the cummulative probability of a gene being in a gene set <span class="math inline">\(G_k\)</span>. At position <span class="math inline">\(p\)</span> in the sorted gene score vector:</p>
<p><span class="math display">\[ f_{1p} = \frac{1}{n_k} \sum_{i=1}^p I(g_i \in G_k) \]</span></p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## original GSEA</span></span>
<span><span class="va">l_set</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">s</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/BiocGenerics/man/match.html" class="external-link">%in%</a></span> <span class="va">geneset</span></span>
<span><span class="va">f1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cumsum</a></span><span class="op">(</span><span class="va">l_set</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">l_set</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## or</span></span>
<span><span class="va">binary_set</span> <span class="op">=</span> <span class="va">l_set</span> <span class="op">+</span> <span class="fl">0</span></span>
<span><span class="va">f1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cumsum</a></span><span class="op">(</span><span class="va">binary_set</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">binary_set</span><span class="op">)</span></span></code></pre></div>
<p>Here in the calculation of <code>f1</code>, <code>sum(l_set)</code> is <span class="math inline">\(n_k\)</span>, <code>cumsum(l_set)</code> is <span class="math inline">\(\sum_{i=1}^p I(g_i \in G_k)\)</span>.</p>
<p>Similarly, we calculate the cummulative distribution of a gene not in the gene set.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">l_other</span> <span class="op">=</span> <span class="op">!</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">s</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/BiocGenerics/man/match.html" class="external-link">%in%</a></span> <span class="va">geneset</span></span>
<span><span class="va">f2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cumsum</a></span><span class="op">(</span><span class="va">l_other</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">l_other</span><span class="op">)</span></span></code></pre></div>
<p><code>f1</code> and <code>f2</code> can be used to plot the CDFs of two distributions.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">n</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">s</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n</span>, <span class="va">f1</span>, type <span class="op">=</span> <span class="st">"l"</span>, col <span class="op">=</span> <span class="st">"red"</span>, xlab <span class="op">=</span> <span class="st">"sorted genes"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n</span>, <span class="va">f2</span>, col <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span></span></code></pre></div>
<p><img src="topic2_04_implement_gsea_files/figure-html/unnamed-chunk-7-1.png" width="700"></p>
<p>The reason why the blue locates almost on the diagonal is the gene set is very small.</p>
<p>Next the difference of cumulative probability (<code>f1 - f2</code>) at each position of the sorted gene list. Let’s call it “the GSEA plot”.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">f1</span> <span class="op">-</span> <span class="va">f2</span>, type <span class="op">=</span> <span class="st">"l"</span>, xlab <span class="op">=</span> <span class="st">"sorted genes"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>h <span class="op">=</span> <span class="fl">0</span>, lty <span class="op">=</span> <span class="fl">2</span>, col <span class="op">=</span> <span class="st">"grey"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/points.html" class="external-link">points</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">l_set</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">l_set</span><span class="op">)</span><span class="op">)</span>, pch <span class="op">=</span> <span class="st">"|"</span>, col <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span></span></code></pre></div>
<p><img src="topic2_04_implement_gsea_files/figure-html/unnamed-chunk-8-1.png" width="700"></p>
<p>So, a large value of <code>f1 - f2</code> means the genes are more like to be in the gene set for those locating at <code>1..p</code>.</p>
<p>The enrichment score (ES) defined as <code>max(f1 - f2)</code> is:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">es</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">f1</span> <span class="op">-</span> <span class="va">f2</span><span class="op">)</span></span>
<span><span class="va">es</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 0.2294643</span></span></code></pre>
<p>And the position in the “GSEA plot”:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">f1</span> <span class="op">-</span> <span class="va">f2</span>, type <span class="op">=</span> <span class="st">"l"</span>, xlab <span class="op">=</span> <span class="st">"sorted genes"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>h <span class="op">=</span> <span class="fl">0</span>, lty <span class="op">=</span> <span class="fl">2</span>, col <span class="op">=</span> <span class="st">"grey"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/points.html" class="external-link">points</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">l_set</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">l_set</span><span class="op">)</span><span class="op">)</span>, pch <span class="op">=</span> <span class="st">"|"</span>, col <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>v <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/which.min.html" class="external-link">which.max</a></span><span class="op">(</span><span class="va">f1</span> <span class="op">-</span> <span class="va">f2</span><span class="op">)</span>, lty <span class="op">=</span> <span class="fl">3</span>, col <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span></span></code></pre></div>
<p><img src="topic2_04_implement_gsea_files/figure-html/unnamed-chunk-10-1.png" width="700"></p>
<p>The statistic <code>es</code> actually is the Kolmogorov-Smirnov statistics, thus, we can directly apply the KS test where the two vectors for the KS test are the positions on the sorted gene list.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/ks.test.html" class="external-link">ks.test</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">l_set</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">l_other</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">##  Asymptotic two-sample Kolmogorov-Smirnov test</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## data:  which(l_set) and which(l_other)</span></span>
<span><span class="co">## D = 0.22946, p-value = 0.244</span></span>
<span><span class="co">## alternative hypothesis: two-sided</span></span></code></pre>
<p>However, we can see the p-value is not significant, this is because KS test is not a powerful test. Next we construct the null distribution by sample permutation.</p>
</div>
<div class="section level3">
<h3 id="sample-permutation">Sample permutation<a class="anchor" aria-label="anchor" href="#sample-permutation"></a>
</h3>
<p>In the next code chunk, the calculation of ES score is wrapped into a function, also we use <code><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans()</a></code> and <code><a href="https://rdrr.io/pkg/matrixStats/man/rowSds.html" class="external-link">rowSds()</a></code> to speed up the calculation of gene-level scores.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/HenrikBengtsson/matrixStats" class="external-link">matrixStats</a></span><span class="op">)</span></span>
<span><span class="co"># expr: the complete expression matrix</span></span>
<span><span class="co"># condition: the condition labels of samples</span></span>
<span><span class="co"># cmp: a vector of two, cmp[1] - cmp[2] &gt; 0 means up-regulation</span></span>
<span><span class="co"># geneset: A vector of genes</span></span>
<span><span class="va">calculate_es</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">expr</span>, <span class="va">condition</span>, <span class="va">cmp</span>, <span class="va">geneset</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>    <span class="va">m1</span> <span class="op">=</span> <span class="va">expr</span><span class="op">[</span>, <span class="va">condition</span> <span class="op">==</span> <span class="va">cmp</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>  <span class="co"># only samples in group 1</span></span>
<span>    <span class="va">m2</span> <span class="op">=</span> <span class="va">expr</span><span class="op">[</span>, <span class="va">condition</span> <span class="op">==</span> <span class="va">cmp</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>  <span class="co"># only samples in group 2</span></span>
<span></span>
<span>    <span class="va">s</span> <span class="op">=</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">m1</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">m2</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/matrixStats/man/rowSds.html" class="external-link">rowSds</a></span><span class="op">(</span><span class="va">m1</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/matrixStats/man/rowSds.html" class="external-link">rowSds</a></span><span class="op">(</span><span class="va">m2</span><span class="op">)</span><span class="op">)</span> <span class="co"># a gene-level difference socre (S2N ratio) </span></span>
<span></span>
<span>    <span class="va">s</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="va">s</span>, decreasing <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>  <span class="co"># ranked gene list</span></span>
<span></span>
<span>    <span class="va">l_set</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">s</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/BiocGenerics/man/match.html" class="external-link">%in%</a></span> <span class="va">geneset</span></span>
<span>    <span class="va">f1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cumsum</a></span><span class="op">(</span><span class="va">l_set</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">l_set</span><span class="op">)</span>   <span class="co"># CDF for genes in the set</span></span>
<span></span>
<span>    <span class="va">l_other</span> <span class="op">=</span> <span class="op">!</span><span class="va">l_set</span></span>
<span>    <span class="va">f2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cumsum</a></span><span class="op">(</span><span class="va">l_other</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">l_other</span><span class="op">)</span>  <span class="co"># CDF for genes not in the set</span></span>
<span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">f1</span> <span class="op">-</span> <span class="va">f2</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>The ES score calculated by <code>calculate_es()</code>:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">es</span> <span class="op">=</span> <span class="fu">calculate_es</span><span class="op">(</span><span class="va">expr</span>, <span class="va">condition</span>, cmp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"WT"</span>, <span class="st">"MUT"</span><span class="op">)</span>, geneset <span class="op">=</span> <span class="va">geneset</span><span class="op">)</span></span>
<span><span class="va">es</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 0.2294643</span></span></code></pre>
<p>We randomly permute sample labels or we randomly permute <code>condition</code>. These two ways are identical. The aim is to break the association between <code>condition</code> and <code>expr</code>.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">condition_random</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/AnnotationDbi/man/Bimap-envirAPI.html" class="external-link">sample</a></span><span class="op">(</span><span class="va">condition</span><span class="op">)</span></span>
<span><span class="va">expr</span> <span class="op">=</span> <span class="va">expr</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/pkg/AnnotationDbi/man/Bimap-envirAPI.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">expr</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<p>We do sample permutation 1000 times. The random ES scores are saved in <code>es_rand</code>.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">es_rand</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="fl">1000</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">1000</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">es_rand</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">=</span> <span class="fu">calculate_es</span><span class="op">(</span><span class="va">expr</span>, <span class="fu"><a href="https://rdrr.io/pkg/AnnotationDbi/man/Bimap-envirAPI.html" class="external-link">sample</a></span><span class="op">(</span><span class="va">condition</span><span class="op">)</span>, </span>
<span>        cmp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"WT"</span>, <span class="st">"MUT"</span><span class="op">)</span>, geneset <span class="op">=</span> <span class="va">geneset</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>p-value is calculated as the proportion of values in <code>es_rand</code> being equal to or larger than <code>es</code>.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">es_rand</span> <span class="op">&gt;=</span> <span class="va">es</span><span class="op">)</span><span class="op">/</span><span class="fl">1000</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 0.129</span></span></code></pre>
<p>The null distribution of ES:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">es_rand</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>v <span class="op">=</span> <span class="va">es</span>, col <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span></span></code></pre></div>
<p><img src="topic2_04_implement_gsea_files/figure-html/unnamed-chunk-16-1.png" width="700"></p>
</div>
</div>
<div class="section level2">
<h2 id="gsea-version-2">GSEA version 2<a class="anchor" aria-label="anchor" href="#gsea-version-2"></a>
</h2>
<p>Next we implement the improved GSEA (Subramanian et al., PNAS, 2005) where gene-level scores are taken as the weight.</p>
<p>We directly modify <code>calculate_es()</code> to <code>calculate_es_v2()</code> where there is only two lines new, which we highlight in the code chunk:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">calculate_es_v2</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">expr</span>, <span class="va">condition</span>, <span class="va">cmp</span>, <span class="va">geneset</span>, <span class="va">plot</span> <span class="op">=</span> <span class="cn">FALSE</span>, <span class="va">power</span> <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>    <span class="va">m1</span> <span class="op">=</span> <span class="va">expr</span><span class="op">[</span>, <span class="va">condition</span> <span class="op">==</span> <span class="va">cmp</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span>    <span class="va">m2</span> <span class="op">=</span> <span class="va">expr</span><span class="op">[</span>, <span class="va">condition</span> <span class="op">==</span> <span class="va">cmp</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span>    <span class="va">s</span> <span class="op">=</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">m1</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">m2</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/matrixStats/man/rowSds.html" class="external-link">rowSds</a></span><span class="op">(</span><span class="va">m1</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/matrixStats/man/rowSds.html" class="external-link">rowSds</a></span><span class="op">(</span><span class="va">m2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">s</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="va">s</span>, decreasing <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">l_set</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">s</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/BiocGenerics/man/match.html" class="external-link">%in%</a></span> <span class="va">geneset</span></span>
<span>    </span>
<span>    <span class="co"># f1 = cumsum(l_set)/sum(l_set)  # &lt;&lt;-- the original line</span></span>
<span>    </span>
<span>    <span class="va">s_set</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">s</span><span class="op">)</span><span class="op">^</span><span class="va">power</span>   <span class="co"># &lt;&lt;-- here</span></span>
<span>    <span class="va">s_set</span><span class="op">[</span><span class="op">!</span><span class="va">l_set</span><span class="op">]</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>    <span class="va">f1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cumsum</a></span><span class="op">(</span><span class="va">s_set</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">s_set</span><span class="op">)</span>  <span class="co">## &lt;&lt;- here</span></span>
<span></span>
<span>    <span class="va">l_other</span> <span class="op">=</span> <span class="op">!</span><span class="va">l_set</span></span>
<span>    <span class="va">f2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cumsum</a></span><span class="op">(</span><span class="va">l_other</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">l_other</span><span class="op">)</span></span>
<span></span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="va">plot</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">f1</span> <span class="op">-</span> <span class="va">f2</span>, type <span class="op">=</span> <span class="st">"l"</span>, xlab <span class="op">=</span> <span class="st">"sorted genes"</span><span class="op">)</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>h <span class="op">=</span> <span class="fl">0</span>, lty <span class="op">=</span> <span class="fl">2</span>, col <span class="op">=</span> <span class="st">"grey"</span><span class="op">)</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/graphics/points.html" class="external-link">points</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">l_set</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">l_set</span><span class="op">)</span><span class="op">)</span>, pch <span class="op">=</span> <span class="st">"|"</span>, col <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>v <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/which.min.html" class="external-link">which.max</a></span><span class="op">(</span><span class="va">f1</span> <span class="op">-</span> <span class="va">f2</span><span class="op">)</span>, lty <span class="op">=</span> <span class="fl">3</span>, col <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">f1</span> <span class="op">-</span> <span class="va">f2</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Now we calculate the new ES score and make the GSEA plot:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">es</span> <span class="op">=</span> <span class="fu">calculate_es_v2</span><span class="op">(</span><span class="va">expr</span>, <span class="va">condition</span>, cmp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"WT"</span>, <span class="st">"MUT"</span><span class="op">)</span>, plot <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>    geneset <span class="op">=</span> <span class="va">geneset</span><span class="op">)</span></span></code></pre></div>
<p><img src="topic2_04_implement_gsea_files/figure-html/unnamed-chunk-18-1.png" width="700"></p>
<p>We can also check when <code>power = 0</code> and <code>power = 2</code>:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">calculate_es_v2</span><span class="op">(</span><span class="va">expr</span>, <span class="va">condition</span>, cmp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"WT"</span>, <span class="st">"MUT"</span><span class="op">)</span>, plot <span class="op">=</span> <span class="cn">TRUE</span>, power <span class="op">=</span> <span class="fl">0</span>, </span>
<span>    geneset <span class="op">=</span> <span class="va">geneset</span><span class="op">)</span>  <span class="co"># same as the original GSEA</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 0.2294643</span></span></code></pre>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/title.html" class="external-link">title</a></span><span class="op">(</span><span class="st">"power = 0"</span><span class="op">)</span></span>
<span><span class="fu">calculate_es_v2</span><span class="op">(</span><span class="va">expr</span>, <span class="va">condition</span>, cmp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"WT"</span>, <span class="st">"MUT"</span><span class="op">)</span>, plot <span class="op">=</span> <span class="cn">TRUE</span>, power <span class="op">=</span> <span class="fl">2</span>, </span>
<span>    geneset <span class="op">=</span> <span class="va">geneset</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 0.8925371</span></span></code></pre>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/title.html" class="external-link">title</a></span><span class="op">(</span><span class="st">"power = 2"</span><span class="op">)</span></span></code></pre></div>
<p><img src="topic2_04_implement_gsea_files/figure-html/unnamed-chunk-19-1.png" width="960"></p>
<p>Similarly, we randomly permute samples to obtain the null distribution of ES:</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">es_rand</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="fl">1000</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">1000</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">es_rand</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">=</span> <span class="fu">calculate_es_v2</span><span class="op">(</span><span class="va">expr</span>, <span class="fu"><a href="https://rdrr.io/pkg/AnnotationDbi/man/Bimap-envirAPI.html" class="external-link">sample</a></span><span class="op">(</span><span class="va">condition</span><span class="op">)</span>, </span>
<span>        cmp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"WT"</span>, <span class="st">"MUT"</span><span class="op">)</span>, geneset <span class="op">=</span> <span class="va">geneset</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>The new p-value:</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">es_rand</span> <span class="op">&gt;=</span> <span class="va">es</span><span class="op">)</span><span class="op">/</span><span class="fl">1000</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 0</span></span></code></pre>
<p>The minimal p-value from 1000 permutations is 1/1000, so zeor here means p-value &lt; 0.001.</p>
<p>And the null distribution of ES:</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">es_rand</span>, xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>v <span class="op">=</span> <span class="va">es</span>, col <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span></span></code></pre></div>
<p><img src="topic2_04_implement_gsea_files/figure-html/unnamed-chunk-22-1.png" width="700"></p>
<p>We can see the improved GSEA is more powerful than the original GSEA, because the original GSEA equally weights genes and the improved GSEA weights genes based on their differential expression, which increases the effect of diff genes. Let’s plot the weight of genes:</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">s</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="topic2_04_implement_gsea_files/figure-html/unnamed-chunk-23-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="gsea-version-2-gene-permutation">GSEA version 2, gene permutation<a class="anchor" aria-label="anchor" href="#gsea-version-2-gene-permutation"></a>
</h2>
<p>Null distribution can also be constructed by gene permutation. It is very easy to implement:</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># s: a vector of pre-calcualted gene-level scores</span></span>
<span><span class="co"># s should be sorted</span></span>
<span><span class="va">calculate_es_v2_gene_perm</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">s</span>, <span class="va">geneset</span>, <span class="va">perm</span> <span class="op">=</span> <span class="cn">FALSE</span>, <span class="va">plot</span> <span class="op">=</span> <span class="cn">FALSE</span>, <span class="va">power</span> <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>    </span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="va">perm</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="co"># s is still sorted, but the gene labels are randomly shuffled</span></span>
<span>        <span class="co"># to break the associations between gene scores and gene labels.</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">s</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/AnnotationDbi/man/Bimap-envirAPI.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">s</span><span class="op">)</span><span class="op">)</span>  <span class="co">## &lt;&lt;- here</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="va">l_set</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">s</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/pkg/BiocGenerics/man/match.html" class="external-link">%in%</a></span> <span class="va">geneset</span></span>
<span>    <span class="va">s_set</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">s</span><span class="op">)</span><span class="op">^</span><span class="va">power</span></span>
<span>    <span class="va">s_set</span><span class="op">[</span><span class="op">!</span><span class="va">l_set</span><span class="op">]</span> <span class="op">=</span> <span class="fl">0</span></span>
<span>    <span class="va">f1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cumsum</a></span><span class="op">(</span><span class="va">s_set</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">s_set</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">l_other</span> <span class="op">=</span> <span class="op">!</span><span class="va">l_set</span></span>
<span>    <span class="va">f2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cumsum</a></span><span class="op">(</span><span class="va">l_other</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">l_other</span><span class="op">)</span></span>
<span></span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="va">plot</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">f1</span> <span class="op">-</span> <span class="va">f2</span>, type <span class="op">=</span> <span class="st">"l"</span>, xlab <span class="op">=</span> <span class="st">"sorted genes"</span><span class="op">)</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>h <span class="op">=</span> <span class="fl">0</span>, lty <span class="op">=</span> <span class="fl">2</span>, col <span class="op">=</span> <span class="st">"grey"</span><span class="op">)</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/graphics/points.html" class="external-link">points</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">l_set</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">l_set</span><span class="op">)</span><span class="op">)</span>, pch <span class="op">=</span> <span class="st">"|"</span>, col <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>v <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/which.min.html" class="external-link">which.max</a></span><span class="op">(</span><span class="va">f1</span> <span class="op">-</span> <span class="va">f2</span><span class="op">)</span>, lty <span class="op">=</span> <span class="fl">3</span>, col <span class="op">=</span> <span class="st">"blue"</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">f1</span> <span class="op">-</span> <span class="va">f2</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Good thing of gene permutation is the gene-level scores only need to be calculated once and can be repeatedly used.</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># pre-calculate gene-level scores</span></span>
<span><span class="va">m1</span> <span class="op">=</span> <span class="va">expr</span><span class="op">[</span>, <span class="va">condition</span> <span class="op">==</span> <span class="st">"WT"</span><span class="op">]</span></span>
<span><span class="va">m2</span> <span class="op">=</span> <span class="va">expr</span><span class="op">[</span>, <span class="va">condition</span> <span class="op">==</span> <span class="st">"MUT"</span><span class="op">]</span></span>
<span></span>
<span><span class="va">s</span> <span class="op">=</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">m1</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">m2</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/matrixStats/man/rowSds.html" class="external-link">rowSds</a></span><span class="op">(</span><span class="va">m1</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/matrixStats/man/rowSds.html" class="external-link">rowSds</a></span><span class="op">(</span><span class="va">m2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">s</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="va">s</span>, decreasing <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>  <span class="co"># must be pre-sorted</span></span></code></pre></div>
<p>The GSEA plot under gene permutation:</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">es</span> <span class="op">=</span> <span class="fu">calculate_es_v2_gene_perm</span><span class="op">(</span><span class="va">s</span>, <span class="va">geneset</span>, plot <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="topic2_04_implement_gsea_files/figure-html/unnamed-chunk-26-1.png" width="700"></p>
<p>We calculate the null distribution of ES from gene permutation:</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">es_rand</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="fl">1000</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">1000</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">es_rand</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">=</span> <span class="fu">calculate_es_v2_gene_perm</span><span class="op">(</span><span class="va">s</span>, <span class="va">geneset</span>, perm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">es_rand</span> <span class="op">&gt;=</span> <span class="va">es</span><span class="op">)</span><span class="op">/</span><span class="fl">1000</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 0</span></span></code></pre>
<p>The real p-value is also &lt; 0.001.</p>
<p>The null distribution of ES from gene permutation:</p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">es_rand</span>, xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>v <span class="op">=</span> <span class="va">es</span>, col <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span></span></code></pre></div>
<p><img src="topic2_04_implement_gsea_files/figure-html/unnamed-chunk-28-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="other-statistics">Other statistics<a class="anchor" aria-label="anchor" href="#other-statistics"></a>
</h2>
<p>Taking <code>es</code> and <code>es_rand</code> calculated previously, NES is calculated as</p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">es</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">es_rand</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 2.692013</span></span></code></pre>
<p>NES does not take into account of the dispersion of <code>es_rand</code>, sometimes z-scores is used instead:</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">es</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">es_rand</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="fu">sd</span><span class="op">(</span><span class="va">es_rand</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 3.483993</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="practice">Practice<a class="anchor" aria-label="anchor" href="#practice"></a>
</h2>
<div class="section level3 tabset">
<h3 class="tabset" id="section"></h3>
<div class="section level4">
<h4 id="practice-1">Practice 1<a class="anchor" aria-label="anchor" href="#practice-1"></a>
</h4>
<p>We have demonstrated two different ways (sample permutation and gene permutation) for calculating p-values. Apply the p53 dataset on the 50 hallmark gene sets, and compare the two enrichment results (e.g. to check which method tends to generate more signficant p-values).</p>
<p>The code we saw so far only applies to a single gene set, you may need to put it into a <code>for</code> loop to go over each of the 50 hallmark gene sets.</p>
</div>
<div class="section level4">
<h4 id="solution">Solution<a class="anchor" aria-label="anchor" href="#solution"></a>
</h4>
<p>The Hallmark gene sets from MSigDB</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/jokergoo/GSEAtraining" class="external-link">GSEAtraining</a></span><span class="op">)</span></span>
<span><span class="va">gs_hallmark</span> <span class="op">=</span> <span class="fu"><a href="../reference/msigdb.html">get_msigdb</a></span><span class="op">(</span>version <span class="op">=</span> <span class="st">"2023.2.Hs"</span>, collection <span class="op">=</span> <span class="st">"h.all"</span>, gene_id_type <span class="op">=</span> <span class="st">"symbol"</span><span class="op">)</span></span>
<span><span class="va">n_gs</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">gs_hallmark</span><span class="op">)</span></span></code></pre></div>
<p>Sample permutation:</p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="va">n_gs</span><span class="op">)</span></span>
<span><span class="va">es1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="va">n_gs</span><span class="op">)</span></span>
<span><span class="va">nes1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="va">n_gs</span><span class="op">)</span></span>
<span><span class="va">z1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="va">n_gs</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n_gs</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">i</span><span class="op">)</span></span>
<span>    <span class="va">geneset</span> <span class="op">=</span> <span class="va">gs_hallmark</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span>    <span class="va">es1</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">=</span> <span class="fu">calculate_es_v2</span><span class="op">(</span><span class="va">expr</span>, <span class="va">condition</span>, </span>
<span>            cmp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"WT"</span>, <span class="st">"MUT"</span><span class="op">)</span>, geneset <span class="op">=</span> <span class="va">geneset</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">es_rand</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="fl">1000</span><span class="op">)</span></span>
<span>    <span class="kw">for</span><span class="op">(</span><span class="va">k</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">1000</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">es_rand</span><span class="op">[</span><span class="va">k</span><span class="op">]</span> <span class="op">=</span> <span class="fu">calculate_es_v2</span><span class="op">(</span><span class="va">expr</span>, <span class="fu"><a href="https://rdrr.io/pkg/AnnotationDbi/man/Bimap-envirAPI.html" class="external-link">sample</a></span><span class="op">(</span><span class="va">condition</span><span class="op">)</span>, </span>
<span>            cmp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"WT"</span>, <span class="st">"MUT"</span><span class="op">)</span>, geneset <span class="op">=</span> <span class="va">geneset</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="va">p1</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">es_rand</span> <span class="op">&gt;=</span> <span class="va">es1</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span><span class="op">/</span><span class="fl">1000</span></span>
<span>    <span class="va">nes1</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">=</span> <span class="va">es1</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">es_rand</span><span class="op">)</span></span>
<span>    <span class="va">z1</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">=</span> <span class="op">(</span><span class="va">es1</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">es_rand</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="fu">sd</span><span class="op">(</span><span class="va">es_rand</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 1</span></span>
<span><span class="co">## [1] 2</span></span>
<span><span class="co">## [1] 3</span></span>
<span><span class="co">## [1] 4</span></span>
<span><span class="co">## [1] 5</span></span>
<span><span class="co">## [1] 6</span></span>
<span><span class="co">## [1] 7</span></span>
<span><span class="co">## [1] 8</span></span>
<span><span class="co">## [1] 9</span></span>
<span><span class="co">## [1] 10</span></span>
<span><span class="co">## [1] 11</span></span>
<span><span class="co">## [1] 12</span></span>
<span><span class="co">## [1] 13</span></span>
<span><span class="co">## [1] 14</span></span>
<span><span class="co">## [1] 15</span></span>
<span><span class="co">## [1] 16</span></span>
<span><span class="co">## [1] 17</span></span>
<span><span class="co">## [1] 18</span></span>
<span><span class="co">## [1] 19</span></span>
<span><span class="co">## [1] 20</span></span>
<span><span class="co">## [1] 21</span></span>
<span><span class="co">## [1] 22</span></span>
<span><span class="co">## [1] 23</span></span>
<span><span class="co">## [1] 24</span></span>
<span><span class="co">## [1] 25</span></span>
<span><span class="co">## [1] 26</span></span>
<span><span class="co">## [1] 27</span></span>
<span><span class="co">## [1] 28</span></span>
<span><span class="co">## [1] 29</span></span>
<span><span class="co">## [1] 30</span></span>
<span><span class="co">## [1] 31</span></span>
<span><span class="co">## [1] 32</span></span>
<span><span class="co">## [1] 33</span></span>
<span><span class="co">## [1] 34</span></span>
<span><span class="co">## [1] 35</span></span>
<span><span class="co">## [1] 36</span></span>
<span><span class="co">## [1] 37</span></span>
<span><span class="co">## [1] 38</span></span>
<span><span class="co">## [1] 39</span></span>
<span><span class="co">## [1] 40</span></span>
<span><span class="co">## [1] 41</span></span>
<span><span class="co">## [1] 42</span></span>
<span><span class="co">## [1] 43</span></span>
<span><span class="co">## [1] 44</span></span>
<span><span class="co">## [1] 45</span></span>
<span><span class="co">## [1] 46</span></span>
<span><span class="co">## [1] 47</span></span>
<span><span class="co">## [1] 48</span></span>
<span><span class="co">## [1] 49</span></span>
<span><span class="co">## [1] 50</span></span></code></pre>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    geneset <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">gs_hallmark</span><span class="op">)</span>,</span>
<span>    es <span class="op">=</span> <span class="va">es1</span>,</span>
<span>    nes <span class="op">=</span> <span class="va">nes1</span>,</span>
<span>    z <span class="op">=</span> <span class="va">z1</span>,</span>
<span>    p_value <span class="op">=</span> <span class="va">p1</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Gene permutation:</p>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m1</span> <span class="op">=</span> <span class="va">expr</span><span class="op">[</span>, <span class="va">condition</span> <span class="op">==</span> <span class="st">"WT"</span><span class="op">]</span></span>
<span><span class="va">m2</span> <span class="op">=</span> <span class="va">expr</span><span class="op">[</span>, <span class="va">condition</span> <span class="op">==</span> <span class="st">"MUT"</span><span class="op">]</span></span>
<span></span>
<span><span class="va">s</span> <span class="op">=</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">m1</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">m2</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/matrixStats/man/rowSds.html" class="external-link">rowSds</a></span><span class="op">(</span><span class="va">m1</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/matrixStats/man/rowSds.html" class="external-link">rowSds</a></span><span class="op">(</span><span class="va">m2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">s</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="va">s</span>, decreasing <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>  <span class="co"># must be pre-sorted</span></span>
<span></span>
<span><span class="va">p2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="va">n_gs</span><span class="op">)</span></span>
<span><span class="va">es2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="va">n_gs</span><span class="op">)</span></span>
<span><span class="va">nes2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="va">n_gs</span><span class="op">)</span></span>
<span><span class="va">z2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="va">n_gs</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n_gs</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">i</span><span class="op">)</span></span>
<span>    <span class="va">geneset</span> <span class="op">=</span> <span class="va">gs_hallmark</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span>    <span class="va">es2</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">=</span> <span class="fu">calculate_es_v2_gene_perm</span><span class="op">(</span><span class="va">s</span>, geneset <span class="op">=</span> <span class="va">geneset</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="va">es_rand</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="fl">1000</span><span class="op">)</span></span>
<span>    <span class="kw">for</span><span class="op">(</span><span class="va">k</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">1000</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">es_rand</span><span class="op">[</span><span class="va">k</span><span class="op">]</span> <span class="op">=</span> <span class="fu">calculate_es_v2_gene_perm</span><span class="op">(</span><span class="va">s</span>, geneset <span class="op">=</span> <span class="va">geneset</span>, perm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="va">p2</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">es_rand</span> <span class="op">&gt;=</span> <span class="va">es2</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span><span class="op">/</span><span class="fl">1000</span></span>
<span>    <span class="va">nes2</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">=</span> <span class="va">es2</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">es_rand</span><span class="op">)</span></span>
<span>    <span class="va">z2</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">=</span> <span class="op">(</span><span class="va">es2</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">es_rand</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="fu">sd</span><span class="op">(</span><span class="va">es_rand</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 1</span></span>
<span><span class="co">## [1] 2</span></span>
<span><span class="co">## [1] 3</span></span>
<span><span class="co">## [1] 4</span></span>
<span><span class="co">## [1] 5</span></span>
<span><span class="co">## [1] 6</span></span>
<span><span class="co">## [1] 7</span></span>
<span><span class="co">## [1] 8</span></span>
<span><span class="co">## [1] 9</span></span>
<span><span class="co">## [1] 10</span></span>
<span><span class="co">## [1] 11</span></span>
<span><span class="co">## [1] 12</span></span>
<span><span class="co">## [1] 13</span></span>
<span><span class="co">## [1] 14</span></span>
<span><span class="co">## [1] 15</span></span>
<span><span class="co">## [1] 16</span></span>
<span><span class="co">## [1] 17</span></span>
<span><span class="co">## [1] 18</span></span>
<span><span class="co">## [1] 19</span></span>
<span><span class="co">## [1] 20</span></span>
<span><span class="co">## [1] 21</span></span>
<span><span class="co">## [1] 22</span></span>
<span><span class="co">## [1] 23</span></span>
<span><span class="co">## [1] 24</span></span>
<span><span class="co">## [1] 25</span></span>
<span><span class="co">## [1] 26</span></span>
<span><span class="co">## [1] 27</span></span>
<span><span class="co">## [1] 28</span></span>
<span><span class="co">## [1] 29</span></span>
<span><span class="co">## [1] 30</span></span>
<span><span class="co">## [1] 31</span></span>
<span><span class="co">## [1] 32</span></span>
<span><span class="co">## [1] 33</span></span>
<span><span class="co">## [1] 34</span></span>
<span><span class="co">## [1] 35</span></span>
<span><span class="co">## [1] 36</span></span>
<span><span class="co">## [1] 37</span></span>
<span><span class="co">## [1] 38</span></span>
<span><span class="co">## [1] 39</span></span>
<span><span class="co">## [1] 40</span></span>
<span><span class="co">## [1] 41</span></span>
<span><span class="co">## [1] 42</span></span>
<span><span class="co">## [1] 43</span></span>
<span><span class="co">## [1] 44</span></span>
<span><span class="co">## [1] 45</span></span>
<span><span class="co">## [1] 46</span></span>
<span><span class="co">## [1] 47</span></span>
<span><span class="co">## [1] 48</span></span>
<span><span class="co">## [1] 49</span></span>
<span><span class="co">## [1] 50</span></span></code></pre>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    geneset <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">gs_hallmark</span><span class="op">)</span>,</span>
<span>    es <span class="op">=</span> <span class="va">es2</span>,</span>
<span>    nes <span class="op">=</span> <span class="va">nes2</span>,</span>
<span>    z <span class="op">=</span> <span class="va">z2</span>,</span>
<span>    p_value <span class="op">=</span> <span class="va">p2</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Compare ES, NES, z-scores, and p-values:</p>
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">df1</span><span class="op">$</span><span class="va">es</span>, <span class="va">df2</span><span class="op">$</span><span class="va">es</span>, main <span class="op">=</span> <span class="st">"ES"</span>,</span>
<span>    xlab <span class="op">=</span> <span class="st">"sample permutation"</span>, ylab <span class="op">=</span> <span class="st">"gene permutation"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">df1</span><span class="op">$</span><span class="va">nes</span>, <span class="va">df2</span><span class="op">$</span><span class="va">nes</span>, main <span class="op">=</span> <span class="st">"NES"</span>, xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2.5</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2.5</span><span class="op">)</span>,</span>
<span>    xlab <span class="op">=</span> <span class="st">"sample permutation"</span>, ylab <span class="op">=</span> <span class="st">"gene permutation"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">df1</span><span class="op">$</span><span class="va">z</span>, <span class="va">df2</span><span class="op">$</span><span class="va">z</span>, main <span class="op">=</span> <span class="st">"Z-score"</span>,</span>
<span>    xlab <span class="op">=</span> <span class="st">"sample permutation"</span>, ylab <span class="op">=</span> <span class="st">"gene permutation"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">df1</span><span class="op">$</span><span class="va">p_value</span>, <span class="va">df2</span><span class="op">$</span><span class="va">p_value</span>, main <span class="op">=</span> <span class="st">"P-value"</span>,</span>
<span>    xlab <span class="op">=</span> <span class="st">"sample permutation"</span>, ylab <span class="op">=</span> <span class="st">"gene permutation"</span><span class="op">)</span></span></code></pre></div>
<p><img src="topic2_04_implement_gsea_files/figure-html/unnamed-chunk-34-1.png" width="960"></p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Zuguang Gu.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
